{
  "key": "HADOOP-151",
  "project": "",
  "fields": {
    "summary": "RPC code has socket leak?",
    "description": "In RPC.java, the field named CLIENT should be neither static, nor a field of RPC. It should be (a) a private nonstatic field of InvocationHandler(),and (just further down), (b) a local variable in the RPC.call() method below.  The comment above the declaration was a bit of giveaway: \n\n   //TODO mb@media-style.com: static client or non-static client?\n  private static Client CLIENT;\t\n\n  private static class Invoker implements InvocationHandler {\n    private InetSocketAddress address;\n\n    public Invoker(InetSocketAddress address, Configuration conf) {\n      this.address = address;\n      CLIENT = (Client) conf.getObject(Client.class.getName());\n      if(CLIENT == null) {\n          CLIENT = new Client(ObjectWritable.class, conf);\n          conf.setObject(Client.class.getName(), CLIENT);\n      }\n    }\n\n    public Object invoke(Object proxy, Method method, Object[] args)\n      throws Throwable {\n      ObjectWritable value = (ObjectWritable)\n        CLIENT.call(new Invocation(method, args), address);\n      return value.get();\n    }\n  }\n\n  /** Construct a client-side proxy object that implements the named protocol,\n   * talking to a server at the named address. */\n  public static Object getProxy(Class protocol, InetSocketAddress addr, Configuration conf) {\n    return Proxy.newProxyInstance(protocol.getClassLoader(),\n                                  new Class[] { protocol },\n                                  new Invoker(addr, conf));\n  }\n\n  /** Expert: Make multiple, parallel calls to a set of servers. */\n  public static Object[] call(Method method, Object[][] params,\n                              InetSocketAddress[] addrs, Configuration conf)\n    throws IOException {\n\n    Invocation[] invocations = new Invocation[params.length];\n    for (int i = 0; i < params.length; i++)\n      invocations[i] = new Invocation(method, params[i]);\n    CLIENT = (Client) conf.getObject(Client.class.getName());\n    if(CLIENT == null) {\n        CLIENT = new Client(ObjectWritable.class, conf);\n        conf.setObject(Client.class.getName(), CLIENT);\n    }\n    Writable[] wrappedValues = CLIENT.call(invocations, addrs);\n    \n    if (method.getReturnType() == Void.TYPE) {\n      return null;\n    }\n\n    Object[] values =\n      (Object[])Array.newInstance(method.getReturnType(),wrappedValues.length);\n    for (int i = 0; i < values.length; i++)\n      if (wrappedValues[i] != null)\n        values[i] = ((ObjectWritable)wrappedValues[i]).get();\n    \n    return values;\n  }. \n",
    "created": "2006-04-20 05:18:25+00:00",
    "updated": "2006-08-03 17:46:36+00:00",
    "status": {
      "self": "https://issues.apache.org/jira/rest/api/2/status/6",
      "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.",
      "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png",
      "name": "Closed",
      "id": "6",
      "statusCategory": {
        "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
        "id": 3,
        "key": "done",
        "colorName": "green",
        "name": "Done"
      }
    },
    "priority": {
      "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
      "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
      "name": "Major",
      "id": "3"
    },
    "assignee": {
      "self": "https://issues.apache.org/jira/rest/api/2/user?username=cutting",
      "name": "cutting",
      "key": "cutting",
      "avatarUrls": {
        "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
        "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
        "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
        "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
      },
      "displayName": "Doug Cutting",
      "active": true,
      "timeZone": "America/Los_Angeles"
    },
    "reporter": {
      "self": "https://issues.apache.org/jira/rest/api/2/user?username=psutter",
      "name": "psutter",
      "key": "psutter",
      "avatarUrls": {
        "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
        "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
        "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
        "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
      },
      "displayName": "Peter Sutter",
      "active": true,
      "timeZone": "Etc/UTC"
    },
    "issue_type": {
      "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
      "id": "1",
      "description": "A problem which impairs or prevents the functions of the product.",
      "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
      "name": "Bug",
      "subtask": false,
      "avatarId": 21133
    },
    "resolution": {
      "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
      "id": "1",
      "description": "A fix for this issue is checked into the tree and tested.",
      "name": "Fixed"
    },
    "resolutiondate": "2006-04-20 06:57:14+00:00",
    "comments": null
  },
  "comments": [
    {
      "id": "12375205",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=cutting",
        "name": "cutting",
        "key": "cutting",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Doug Cutting",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "What's the problem with a static CLIENT?  What problems does this cause?  The client has the connection pool, so one potential problem is that, a large request or response will delay other requests or responses to/from the same host.  Is that the issue you're seeing?  If so, can you provide more details about the circumstances where this occurs?\n",
      "created": "2006-04-20 05:26:50+00:00",
      "updated": "2006-04-20 05:26:50+00:00"
    },
    {
      "id": "12375209",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=psutter",
        "name": "psutter",
        "key": "psutter",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Peter Sutter",
        "active": true,
        "timeZone": "Etc/UTC"
      },
      "body": "\nIf thre is only one Client object, then you're right, its OK that its static. \n\nThe fact that the object is also stored in the conf - combined with the comment - made it look like a coding error (since its not accessed by anything but those parts of the code).\n\n",
      "created": "2006-04-20 05:50:50+00:00",
      "updated": "2006-04-20 05:50:50+00:00"
    },
    {
      "id": "12375212",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=cutting",
        "name": "cutting",
        "key": "cutting",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Doug Cutting",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "You're right, that code got uglified by the configuration stuff.  There should only need to be a single Client for RPC.  Each Client keeps a cache of TCP connections to other host:port pairs expecting the same Writable class for requests and responses.  All RPCs use Invocation as the request class and ObjectWritable as the response class, so they can generally share connections.\n\nThe problem is that there's no longer a global configuration.  So a global client could be lazily constructed the first time a call is made with the invoker's configuration.  Or we could create a new client for each configuration.  But, you're right, we shouldn't do both, as the current code does.  Changing the global CLIENT shouldn't break anything, but it's also silly and wasteful.  The only thing the client reads from the configuration is the RPC timeout.  It might almost be better to remove the configuration from Client altogether and always explicitly pass the timeout as a parameter to call().\n\nI wonder if this could even be leading to socket leaks?  Hmm.  A client doesn't close it's connections until it's either explicitly closed (which these are not) or until the remote server dies.  So we should probably fix this somehow.",
      "created": "2006-04-20 06:11:43+00:00",
      "updated": "2006-04-20 06:11:43+00:00"
    },
    {
      "id": "12375220",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=cutting",
        "name": "cutting",
        "key": "cutting",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Doug Cutting",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "I just fixed this.  I restored the original behaviour, where a single client is used for all calls, regardless of the configuration.  This results in the use of a single connection pool for all RPC calls, and hence closes a potential socket leak.  Long-term we might consider other approaches to pooling connections.  Today it seemed more important to close the leak than to, e.g., permit different ipc timeouts for different jobs.",
      "created": "2006-04-20 06:57:11+00:00",
      "updated": "2006-04-20 06:57:11+00:00"
    }
  ]
}