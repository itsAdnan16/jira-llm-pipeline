{
  "key": "HADOOP-277",
  "project": "HADOOP",
  "fields": {
    "summary": "Race condition in Configuration.getLocalPath()",
    "description": "(attached: a patch to fix the problem, and a logfile showing the problem occuring twice)\n\nThere is a race condition in Configuration.java:\n\n       Path file = new Path(dirs[index], path);\n       Path dir = file.getParent();\n       if (fs.exists(dir) || fs.mkdirs(dir)) {\n         return file;\n\nIf two threads simultaneously process this code with the same target directory, fs.exists() will return false, but from fs.mkdirs() only one of the two threads will return true. From the Java documentation:\n \"returns: true if and only if the directory was created, along with all necessary parent directories; false otherwise\"\n\nThat is, if the first thread successfully creates the directory, the second will not, and therefore return false, even though the directory exists.\n\nThis was really happening. We use four temporary directories, and we had reducers failing all over the place with  bizarre impossible errors. I modified the ReduceTaskRunner to output the filename that it creates to find the problem, and the log output is below.\n\nHere you can see copies initiated for two files that hash to the same temp directory, simultaneously. map_4.out is created in the correct directory (/data2...), but map_15.out is created in the next directory (/data3...) becuase of this race condition. Minutes later, when the appender tries to locate the file, that race condition does not occur (the directory already exists), and the appender looks for the file map_15.out in the correct directory, where it does not exist.\n\n060605 142414 task_0001_r_000009_1 Copying task_0001_m_000004_0 output from rmr05.\n060605 142414 task_0001_r_000009_1 Copying task_0001_m_000015_0 output from rmr04.\n...\n060605 142416 task_0001_r_000009_1 done copying task_0001_m_000004_0 output from rmr05 into /data2/tmp/mapred/local/task_0001_r_000009_1/map_4.out\n...\n060605 142418 task_0001_r_000009_1 done copying task_0001_m_000015_0 output from rmr04 into /data3/tmp/mapred/local/task_0001_r_000009_1/map_15.out\n...\n060605 142531 task_0001_r_000009_1 0.31808624% reduce > append > /data2/tmp/mapred/local/task_0001_r_000009_1/map_4.out\n...\n060605 142725 task_0001_r_000009_1 java.io.FileNotFoundException: /data2/tmp/mapred/local/task_0001_r_000009_1/map_15.out\n\n\n",
    "created": "2006-06-06 08:11:33+00:00",
    "updated": "2006-08-03 17:46:45+00:00",
    "status": {
      "self": "https://issues.apache.org/jira/rest/api/2/status/6",
      "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.",
      "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png",
      "name": "Closed",
      "id": "6",
      "statusCategory": {
        "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
        "id": 3,
        "key": "done",
        "colorName": "green",
        "name": "Done"
      }
    },
    "priority": {
      "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
      "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
      "name": "Major",
      "id": "3"
    },
    "assignee": {
      "self": "https://issues.apache.org/jira/rest/api/2/user?username=sameerp",
      "name": "sameerp",
      "key": "sameerp",
      "avatarUrls": {
        "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34061",
        "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34061",
        "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34061",
        "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34061"
      },
      "displayName": "Sameer Paranjpye",
      "active": true,
      "timeZone": "America/Los_Angeles"
    },
    "reporter": {
      "self": "https://issues.apache.org/jira/rest/api/2/user?username=psutter",
      "name": "psutter",
      "key": "psutter",
      "avatarUrls": {
        "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
        "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
        "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
        "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
      },
      "displayName": "Peter Sutter",
      "active": true,
      "timeZone": "Etc/UTC"
    },
    "issue_type": {
      "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
      "id": "1",
      "description": "A problem which impairs or prevents the functions of the product.",
      "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
      "name": "Bug",
      "subtask": false,
      "avatarId": 21133
    },
    "resolution": {
      "self": "https://issues.apache.org/jira/rest/api/2/resolution/1",
      "id": "1",
      "description": "A fix for this issue is checked into the tree and tested.",
      "name": "Fixed"
    },
    "resolutiondate": "2006-06-08 02:35:46+00:00",
    "comments": null
  },
  "comments": [
    {
      "id": "12414897",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=omalley",
        "name": "omalley",
        "key": "owen.omalley",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=54139",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=54139",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=54139",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=54139"
        },
        "displayName": "Owen O'Malley",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "This patch is closer to what we did for the routine above it last week. (Sorry about not fixing this one too at the same time. It wasn't biting us, but that was no reason not to fix the obviously parallel code.)  Is there some reason that you need the synchronized block around the mkdirs? File.mkdirs does a File.exists internally, so you don't need to call it yourself.",
      "created": "2006-06-06 10:11:55+00:00",
      "updated": "2006-06-06 10:11:55+00:00"
    },
    {
      "id": "12414901",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=omalley",
        "name": "omalley",
        "key": "owen.omalley",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=54139",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=54139",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=54139",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=54139"
        },
        "displayName": "Owen O'Malley",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "By the way, if there is a need for the sync block around the mkdirs, we should go ahead and change the function above it so that next week we don't get a third bug. *smile*",
      "created": "2006-06-06 11:15:07+00:00",
      "updated": "2006-06-06 11:15:07+00:00"
    },
    {
      "id": "12414918",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=nnalam",
        "name": "nnalam",
        "key": "nnalam",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Naveen Nalam",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "If we take out the sync block, the code would look like:\n\nif (fs.exists(dir)) {\n  return file;\n}\nfs.mkdirs(dir);\nif (fs.exists(dir)) {\n  return file;\n}\n\nwe added the sync block around the mkdirs because we were not sure exactly how mkdirs() handles race cases. for example if one thread is creating the directory hierarchy, can the other thread return error while the first thread is still creating the hierarchy? if so when the second thread executes fs.exists(), it would return false since the directories are still be created. \n\nbut perhaps this isn't the behavior mkdirs() exhibits. it could return false only if it can't create the final leaf directory in the directory hierarchy (because the other thread just created the leaf). if that's the case then the sync would not be needed. the sun java api doc isn't clear on this.",
      "created": "2006-06-06 13:07:16+00:00",
      "updated": "2006-06-06 13:07:16+00:00"
    },
    {
      "id": "12414990",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=omalley",
        "name": "omalley",
        "key": "owen.omalley",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=54139",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=54139",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=54139",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=54139"
        },
        "displayName": "Owen O'Malley",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "The File.mkdirs (based on what I see in eclipse) looks like:\n\n    public boolean mkdirs() {\n        if (exists()) {\n            return false;\n        }\n        if (mkdir()) {\n            return true;\n        }\n        ... <handle recursive mkdirs>...\n    }\n\nin any case, the final mkdir would need to be the last thing done. Without the sync block, I believe your code is functionally identical to my proposal of:\n\nif (fs.mkdirs(dir) || fs.exists(dir)) {\n   return file;\n}\n\nOr am I missing something? If we need to synchronize, we really need to do it everywhere and do it consistently.\n\nOn a side note, the Configuration's getFile roll-over between local directories is problematic. The problem is that readers need to find the file regardless of where it was written. So if the writer can spill over to other directories, there should be a findFile(?) that looks in all of the directories (in the right order) until it finds it. That way readers can find the file regardless of which directory the writer was spilled in to.",
      "created": "2006-06-06 23:46:28+00:00",
      "updated": "2006-06-06 23:46:28+00:00"
    },
    {
      "id": "12414991",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=sameerp",
        "name": "sameerp",
        "key": "sameerp",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34061",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34061",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34061",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34061"
        },
        "displayName": "Sameer Paranjpye",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "Not sure I understand that, a sync block would still not  protect againt multiple processes trying to create the same hierarchy, and the races would still bite you...\n\nMaybe the safest thing to do is to traverse the hierarchy in getLocalPath(), creating each directory and checking\nfor it's existence.\n  \n\n",
      "created": "2006-06-06 23:56:12+00:00",
      "updated": "2006-06-06 23:56:12+00:00"
    },
    {
      "id": "12414996",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=psutter",
        "name": "psutter",
        "key": "psutter",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Peter Sutter",
        "active": true,
        "timeZone": "Etc/UTC"
      },
      "body": "\nSameer -> I think you're right. Ultimately, the synchronize is not good enough, and it seems that you've got the right solution.\n\nOwen ->  here's the case Naveen described: lets say five directory levels are created by the call to mkdirs(), and there are two threads entering mkrdirs() at about the same time. Will one of the two threads exit before the fifth directory is created? I dont have the source code, but it seems to me that it could. If that would happen, that thread will step ahead to the next directory because when it does the exists() check, the directory will not exist. Which leads to Sameer's point that even the synchronize is not good enough.\n\n\n\n",
      "created": "2006-06-07 00:31:38+00:00",
      "updated": "2006-06-07 00:31:38+00:00"
    },
    {
      "id": "12414999",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=nnalam",
        "name": "nnalam",
        "key": "nnalam",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Naveen Nalam",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "Below is what mkdirs looks like according to the jad decompiler (File.class from is from Sun JDK 1.5).\n\nIt looks like to me if two processes/threads are trying to create \"/a/b/c/d/e/\" and nothing yet exists, they both try to create \"/a\". One will fail, while the other succeeds. The failing process will return failure early, while the other process continues to create \"b/c/d/e/\". If the failing process after returning from mkdirs() now calls exists(\"/a/b/c/d/e\"), exists() could  return false because the other process is still creating the directories along the path.\n\nSo probably Sameer's suggestion of traversing in getLocalPath() is the best solution.\n\npublic boolean mkdirs()\n    {\n        if(exists())\n            return false;\n        if(mkdir())\n            return true;\n        File file = null;\n        try\n        {\n            file = getCanonicalFile();\n        }\n        catch(IOException ioexception)\n        {\n            return false;\n        }\n        String s = file.getParent();\n        return s != null && (new File(s, fs.prefixLength(s))).mkdirs() && file.mkdir();\n    }\n",
      "created": "2006-06-07 01:00:51+00:00",
      "updated": "2006-06-07 01:00:51+00:00"
    },
    {
      "id": "12415002",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=omalley",
        "name": "omalley",
        "key": "owen.omalley",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=54139",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=54139",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=54139",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=54139"
        },
        "displayName": "Owen O'Malley",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "Ok, I see your point. \n\nLet's go with the traversing, but I think it should be done in the FileSystem.mkdirs rather than in Configuration.",
      "created": "2006-06-07 01:12:47+00:00",
      "updated": "2006-06-07 01:12:47+00:00"
    },
    {
      "id": "12415024",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=nnalam",
        "name": "nnalam",
        "key": "nnalam",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Naveen Nalam",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "FileSystem.mkdirs is an abstract method. It would have been nice to put the traversal logic there. FSDirectory.mkdirs() already does a traversal like we need, so perhaps that code can be copied and modified for LocalFileSystem.mkdirs() ?",
      "created": "2006-06-07 02:58:54+00:00",
      "updated": "2006-06-07 02:58:54+00:00"
    },
    {
      "id": "12415029",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=omalley",
        "name": "omalley",
        "key": "owen.omalley",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=54139",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=54139",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=54139",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=54139"
        },
        "displayName": "Owen O'Malley",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "Sameer is working on a fix for this in LocalFileSystem.mkdirs()",
      "created": "2006-06-07 03:10:33+00:00",
      "updated": "2006-06-07 03:10:33+00:00"
    },
    {
      "id": "12415052",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=sameerp",
        "name": "sameerp",
        "key": "sameerp",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34061",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34061",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34061",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34061"
        },
        "displayName": "Sameer Paranjpye",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "Attached patch for mkdir issue. LocalFileSystem.mkdirs() now traverses the hierarchy creating each directory along the way. This patch changes the semantics of  'mkdirs' in the FileSystem interface. The semantics are now those of 'mkdir -p', in that existence of the specified directory or any ancestor of it is no longer an error.\n\nAlso updates mkdirs in dfs.FSDirectory so that it has the same behavior.",
      "created": "2006-06-07 04:29:27+00:00",
      "updated": "2006-06-07 04:29:27+00:00"
    },
    {
      "id": "12415189",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=cutting",
        "name": "cutting",
        "key": "cutting",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Doug Cutting",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "This patch conflicts with HADOOP-240, which I just committed.  Can you please resolve this?  Thanks.",
      "created": "2006-06-08 01:21:49+00:00",
      "updated": "2006-06-08 01:21:49+00:00"
    },
    {
      "id": "12415197",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=sameerp",
        "name": "sameerp",
        "key": "sameerp",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34061",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34061",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34061",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34061"
        },
        "displayName": "Sameer Paranjpye",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "Attached new patch.",
      "created": "2006-06-08 02:18:43+00:00",
      "updated": "2006-06-08 02:18:43+00:00"
    },
    {
      "id": "12415199",
      "author": {
        "self": "https://issues.apache.org/jira/rest/api/2/user?username=cutting",
        "name": "cutting",
        "key": "cutting",
        "avatarUrls": {
          "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452",
          "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
          "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
          "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"
        },
        "displayName": "Doug Cutting",
        "active": true,
        "timeZone": "America/Los_Angeles"
      },
      "body": "I just committed this.  Thanks, Sameer!",
      "created": "2006-06-08 02:35:46+00:00",
      "updated": "2006-06-08 02:35:46+00:00"
    }
  ]
}